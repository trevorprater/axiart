name: Cross-Platform Tests

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test-matrix:
    name: Test on ${{ matrix.os }} with Python ${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        python-version: ['3.9', '3.10', '3.11', '3.12']
        exclude:
          # Reduce matrix size - test newer Python on all OS, older on Ubuntu only
          - os: macos-latest
            python-version: '3.9'
          - os: macos-latest
            python-version: '3.10'
          - os: windows-latest
            python-version: '3.9'
          - os: windows-latest
            python-version: '3.10'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable

    - name: Cache Rust dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: axiart-core

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: false

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Python dependencies
      run: uv sync

    - name: Build Rust library
      run: uv run maturin develop --release

    - name: Test pattern imports
      run: |
        uv run python -c "
        from axiart.patterns import VoronoiPattern, LSystemPattern, TruchetPattern
        print('✓ VoronoiPattern imported')
        print('✓ LSystemPattern imported')
        print('✓ TruchetPattern imported')
        "

    - name: Test pattern generation (quick)
      run: |
        uv run python -c "
        from axiart.patterns import VoronoiPattern, LSystemPattern, TruchetPattern
        from axiart import SVGCanvas

        # Test Voronoi
        canvas = SVGCanvas(width=100, height=100)
        canvas.create_layer('test', color='black')
        v = VoronoiPattern(width=100, height=100, num_sites=10, seed=42)
        v.generate()
        print(f'✓ Voronoi: {len(v.get_sites())} sites, {len(v.get_edges())} edges')

        # Test L-System
        l = LSystemPattern(width=100, height=100, preset='koch', iterations=3)
        l.generate()
        print(f'✓ L-System: {len(l.get_lines())} lines')

        # Test Truchet
        t = TruchetPattern(width=100, height=100, grid_size=5, seed=42)
        t.generate()
        print(f'✓ Truchet: {len(t.get_lines())} lines, {len(t.get_curves())} curves')

        print('✓ All patterns generated successfully on ${{ matrix.os }} with Python ${{ matrix.python-version }}')
        "

    - name: Run example (Ubuntu only)
      if: matrix.os == 'ubuntu-latest'
      run: |
        cd examples
        uv run python example_voronoi.py
        ls -lh output_voronoi.svg
